<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lumen Coder - AI Assistant</title>
  <style>
:root {
  --primary: #8b5cf6;
  --primary-hover: #7c3aed;
  --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
  --glass-bg: rgba(255, 255, 255, 0.03);
  --glass-border: rgba(255, 255, 255, 0.1);
  --text-main: #f1f5f9;
  --text-muted: #94a3b8;
  --accent-green: #10b981;
  --accent-red: #ef4444;
  --panel-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, sans-serif;
  background: var(--bg-gradient);
  background-attachment: fixed;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  color: var(--text-main);
  overflow: hidden;
}

/* Scrollbar Styling */
::-webkit-scrollbar {
  width: 6px;
}
::-webkit-scrollbar-track {
  background: transparent;
}
::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
}

/* Login Screen Overhaul */
#login-screen {
  background: rgba(30, 41, 59, 0.7);
  backdrop-filter: blur(12px);
  padding: 3rem;
  border-radius: 1.5rem;
  border: 1px solid var(--glass-border);
  box-shadow: var(--panel-shadow);
  width: 100%;
  max-width: 420px;
  text-align: center;
}

#login-screen h1 {
  font-size: 2rem;
  font-weight: 800;
  background: linear-gradient(to right, #a78bfa, #60a5fa);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 2rem;
}

#login-screen input {
  width: 100%;
  background: rgba(0, 0, 0, 0.2);
  border: 1px solid var(--glass-border);
  color: white;
  padding: 1rem;
  border-radius: 0.75rem;
  margin-bottom: 1.5rem;
  font-size: 1rem;
  transition: all 0.3s;
}

#login-screen input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2);
}

#login-screen input::placeholder {
  color: var(--text-muted);
}

#login-screen button {
  width: 100%;
  background: var(--primary);
  color: white;
  border: none;
  font-weight: 600;
  letter-spacing: 0.5px;
  padding: 1rem;
  border-radius: 0.75rem;
  cursor: pointer;
  font-size: 1rem;
  transition: transform 0.2s, background 0.3s;
}

#login-screen button:hover {
  background: var(--primary-hover);
  transform: translateY(-2px);
}

.error {
  color: var(--accent-red);
  font-size: 0.875rem;
  margin-top: 0.5rem;
}

/* Main Chat Container */
#chat-container {
  display: none;
  background: rgba(15, 23, 42, 0.6);
  backdrop-filter: blur(20px);
  width: 95%;
  max-width: 1300px;
  height: 90vh;
  border-radius: 1.25rem;
  border: 1px solid var(--glass-border);
  box-shadow: var(--panel-shadow);
  flex-direction: column;
  overflow: hidden;
}

#chat-header {
  padding: 1.25rem 2rem;
  background: rgba(255, 255, 255, 0.02);
  border-bottom: 1px solid var(--glass-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#chat-header h1 {
  font-size: 1.1rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

#chat-header h1::before {
  content: '';
  width: 8px;
  height: 8px;
  background: var(--accent-green);
  border-radius: 50%;
  box-shadow: 0 0 10px var(--accent-green);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.4; }
  100% { opacity: 1; }
}

#controls {
  display: flex;
  gap: 1rem;
  align-items: center;
}

#controls label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.875rem;
  cursor: pointer;
}

#controls button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--glass-border);
  color: var(--text-main);
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s;
}

#controls button:hover {
  background: rgba(255, 255, 255, 0.1);
}

/* Messages Area */
#messages {
  flex: 1;
  overflow-y: auto;
  padding: 2rem;
  background: transparent;
}

.message {
  margin-bottom: 1.5rem;
  max-width: 85%;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message.user {
  margin-left: auto;
}

.message-content {
  padding: 1rem 1.25rem;
  border-radius: 1.25rem;
  font-size: 0.95rem;
  line-height: 1.6;
  position: relative;
  word-wrap: break-word;
}

.message.user .message-content {
  background: var(--primary);
  color: white;
  border-bottom-right-radius: 0.25rem;
}

.message.assistant .message-content {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--glass-border);
  color: var(--text-main);
  border-bottom-left-radius: 0.25rem;
}

.message.system {
  text-align: center;
}

.message.system .message-content {
  background: rgba(96, 165, 250, 0.1);
  color: #93c5fd;
  border: 1px solid rgba(96, 165, 250, 0.2);
  font-family: 'JetBrains Mono', 'Fira Code', monospace;
  font-size: 0.85rem;
  display: inline-block;
  max-width: 90%;
}

.message.error .message-content {
  background: rgba(239, 68, 68, 0.1);
  color: #fca5a5;
  border: 1px solid rgba(239, 68, 68, 0.2);
}

/* Code Blocks & Terminal */
.code-block, .terminal-output {
  margin-top: 1rem;
  padding: 1rem;
  border-radius: 0.75rem;
  border: 1px solid rgba(0, 0, 0, 0.3);
  font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
  font-size: 0.85rem;
  position: relative;
  overflow-x: auto;
  line-height: 1.5;
}

.code-block {
  background: #010409;
  color: #e6edf3;
}

.terminal-output {
  background: #161b22;
  color: #7ee787;
  border-left: 3px solid var(--accent-green);
}

/* Copy Code Button */
.copy-button {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: var(--text-main);
  padding: 0.25rem 0.75rem;
  border-radius: 0.375rem;
  font-size: 0.75rem;
  cursor: pointer;
  opacity: 0;
  transition: all 0.2s;
}

.code-block:hover .copy-button,
.terminal-output:hover .copy-button {
  opacity: 1;
}

.copy-button:hover {
  background: rgba(255, 255, 255, 0.2);
}

.copy-button.copied {
  background: var(--accent-green);
  border-color: var(--accent-green);
  color: white;
}

/* Input Area */
#input-area {
  padding: 1.5rem 2rem;
  background: rgba(255, 255, 255, 0.02);
  border-top: 1px solid var(--glass-border);
  display: flex;
  gap: 1rem;
}

#message-input {
  flex: 1;
  background: rgba(0, 0, 0, 0.2);
  border: 1px solid var(--glass-border);
  color: white;
  padding: 1rem 1.25rem;
  border-radius: 0.75rem;
  font-size: 1rem;
  font-family: inherit;
  transition: all 0.3s;
}

#message-input::placeholder {
  color: var(--text-muted);
}

#message-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
}

#send-button {
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 0.75rem;
  font-weight: 600;
  font-size: 1rem;
  padding: 0 1.5rem;
  cursor: pointer;
  transition: all 0.2s;
}

#send-button:hover:not(:disabled) {
  background: var(--primary-hover);
  transform: translateY(-1px);
}

#send-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Typing Indicator */
.typing-indicator {
  display: inline-flex;
  gap: 0.25rem;
  padding: 0.75rem 1rem;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--glass-border);
  border-radius: 1.25rem;
  border-bottom-left-radius: 0.25rem;
}

.typing-indicator span {
  width: 8px;
  height: 8px;
  background: var(--text-muted);
  border-radius: 50%;
  animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%, 60%, 100% {
    transform: translateY(0);
  }
  30% {
    transform: translateY(-10px);
  }
}
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="login-screen">
    <h1>ðŸ¤– Lumen Coder</h1>
    <input type="password" id="password-input" placeholder="Enter admin password" />
    <button id="login-button">Login</button>
    <div id="login-error" class="error"></div>
  </div>

  <!-- Chat Interface -->
  <div id="chat-container">
    <div id="chat-header">
      <h1>ðŸ¤– Lumen Coder - AI Assistant</h1>
      <div id="controls">
        <label>
          <input type="checkbox" id="auto-approve-toggle">
          Auto-approve commands
        </label>
        <button id="stats-button">ðŸ“Š Stats</button>
        <button id="logout-button">ðŸšª Logout</button>
      </div>
    </div>
    <div id="messages"></div>
    <div id="input-area">
      <input type="text" id="message-input" placeholder="Ask me anything..." />
      <button id="send-button">Send</button>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin;
    const WS_URL = window.location.protocol === 'https:' 
      ? API_URL.replace('https', 'wss')
      : API_URL.replace('http', 'ws');
    
    let ws = null;
    let token = null;
    let isProcessing = false;

    // DOM elements
    const loginScreen = document.getElementById('login-screen');
    const chatContainer = document.getElementById('chat-container');
    const passwordInput = document.getElementById('password-input');
    const loginButton = document.getElementById('login-button');
    const loginError = document.getElementById('login-error');
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const autoApproveToggle = document.getElementById('auto-approve-toggle');
    const statsButton = document.getElementById('stats-button');
    const logoutButton = document.getElementById('logout-button');

    // Login
    loginButton.addEventListener('click', async () => {
      const password = passwordInput.value;
      
      try {
        const response = await fetch(`${API_URL}/api/auth`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        
        const data = await response.json();
        
        if (data.success) {
          token = data.token;
          loginScreen.style.display = 'none';
          chatContainer.style.display = 'flex';
          connectWebSocket();
        } else {
          loginError.textContent = 'Invalid password';
        }
      } catch (error) {
        loginError.textContent = 'Connection error';
      }
    });

    passwordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') loginButton.click();
    });

    // WebSocket connection
    function connectWebSocket() {
      ws = new WebSocket(WS_URL);
      
      ws.onopen = () => {
        console.log('WebSocket connected');
        ws.send(JSON.stringify({ type: 'auth', token }));
      };
      
      ws.onmessage = (event) => {
        const message = JSON.parse(event.data);
        handleWebSocketMessage(message);
      };
      
      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        addMessage('system', 'Connection error');
      };
      
      ws.onclose = () => {
        console.log('WebSocket closed');
        addMessage('system', 'Disconnected');
      };
    }

    // Handle WebSocket messages
    function handleWebSocketMessage(message) {
      switch (message.type) {
        case 'auth-success':
          addMessage('system', 'Connected successfully');
          break;
          
        case 'auth-failed':
          addMessage('error', 'Authentication failed');
          logout();
          break;
          
        case 'status':
          addMessage('system', message.message);
          break;
          
        case 'response':
          handleAgentResponse(message.data);
          break;
          
        case 'execution':
          handleExecutionResult(message.result);
          break;
          
        case 'tool-response':
          handleToolResponse(message.tool, message.data);
          break;
          
        case 'complete':
          isProcessing = false;
          sendButton.disabled = false;
          removeTypingIndicator();
          break;
          
        case 'error':
          addMessage('error', message.message);
          isProcessing = false;
          sendButton.disabled = false;
          removeTypingIndicator();
          break;
          
        case 'warning':
          addMessage('system', message.message);
          break;
      }
    }

    // Handle agent response
    function handleAgentResponse(data) {
      if (data.choice === 'response') {
        addMessage('assistant', data.response);
      } else if (data.choice === 'code') {
        addMessage('assistant', `**${data.language} Code:**\n\n${data.codeExplanation}`, data.code, data.language);
      } else if (data.choice === 'terminalCommand') {
        addMessage('assistant', `**Terminal Command:**\n\`${data.terminalCommand}\`\n\n${data.commandReasoning}`);
      }
    }

    // Handle execution result
    function handleExecutionResult(result) {
      if (result.status === 'success') {
        addMessage('assistant', '**Execution Result:**', result.stdout || 'Command executed successfully', 'terminal');
      } else {
        addMessage('error', `**Execution Failed:**\n${result.message}`);
      }
    }

    // Handle tool response
    function handleToolResponse(tool, data) {
      if (data.fileTree) {
        addMessage('assistant', '**File Tree:**', data.fileTree, 'tree');
      } else if (data.summary) {
        addMessage('assistant', `**Summary:**\n\n${data.summary}`);
      }
    }

    // Add message to chat
    function addMessage(type, text, code = null, codeType = null) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      
      // Format text with markdown-like syntax
      let formattedText = text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\n/g, '<br>');
      
      contentDiv.innerHTML = formattedText;
      
      if (code) {
        const codeBlock = document.createElement('div');
        codeBlock.className = codeType === 'terminal' ? 'terminal-output' : 'code-block';
        codeBlock.textContent = code;
        
        // Add copy button
        const copyButton = document.createElement('button');
        copyButton.className = 'copy-button';
        copyButton.textContent = 'Copy';
        copyButton.onclick = () => copyCode(copyButton, code);
        
        codeBlock.appendChild(copyButton);
        contentDiv.appendChild(codeBlock);
      }
      
      messageDiv.appendChild(contentDiv);
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Copy code to clipboard
    function copyCode(button, code) {
      navigator.clipboard.writeText(code).then(() => {
        button.textContent = 'âœ“ Copied';
        button.classList.add('copied');
        setTimeout(() => {
          button.textContent = 'Copy';
          button.classList.remove('copied');
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy:', err);
        button.textContent = 'âœ— Failed';
        setTimeout(() => {
          button.textContent = 'Copy';
        }, 2000);
      });
    }

    // Typing indicator
    function addTypingIndicator() {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message assistant';
      messageDiv.id = 'typing-indicator';
      
      const indicator = document.createElement('div');
      indicator.className = 'typing-indicator';
      indicator.innerHTML = '<span></span><span></span><span></span>';
      
      messageDiv.appendChild(indicator);
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function removeTypingIndicator() {
      const indicator = document.getElementById('typing-indicator');
      if (indicator) indicator.remove();
    }

    // Send message
    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || isProcessing) return;
      
      addMessage('user', text);
      messageInput.value = '';
      
      isProcessing = true;
      sendButton.disabled = true;
      addTypingIndicator();
      
      ws.send(JSON.stringify({
        type: 'message',
        text
      }));
    }

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Auto-approve toggle
    autoApproveToggle.addEventListener('change', () => {
      ws.send(JSON.stringify({
        type: 'set-auto-approve',
        value: autoApproveToggle.checked
      }));
    });

    // Stats button
    statsButton.addEventListener('click', async () => {
      try {
        const response = await fetch(`${API_URL}/api/stats`);
        const stats = await response.json();
        
        const statsText = `**Memory Statistics:**
Total interactions: ${stats.totalInteractionsProcessed}
Current stored: ${stats.currentInteractionsStored}
Summaries: ${stats.summariesStored}
Oldest: ${stats.oldestInteraction || 'N/A'}
Newest: ${stats.newestInteraction || 'N/A'}`;
        
        addMessage('system', statsText);
      } catch (error) {
        addMessage('error', 'Failed to fetch stats');
      }
    });

    // Logout
    function logout() {
      if (ws) ws.close();
      token = null;
      chatContainer.style.display = 'none';
      loginScreen.style.display = 'block';
      messagesDiv.innerHTML = '';
      passwordInput.value = '';
      loginError.textContent = '';
    }

    logoutButton.addEventListener('click', logout);
  </script>
</body>
</html>
